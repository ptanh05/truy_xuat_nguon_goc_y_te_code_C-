@page
@model QRCodeScannerModel
@{
    ViewData["Title"] = "QR Code Scanner";
}

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-md-12">
            <h1 class="mb-4">QR Code Scanner</h1>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Scanner</h5>
                </div>
                <div class="card-body">
                    <video id="scanner" style="width: 100%; border: 2px solid #ddd; border-radius: 5px;"></video>
                    <div class="mt-3">
                        <button class="btn btn-primary" onclick="startScanner()">Start Scanner</button>
                        <button class="btn btn-danger" onclick="stopScanner()">Stop Scanner</button>
                    </div>
                    <div class="mt-3">
                        <label class="form-label">Manual Input</label>
                        <input type="text" class="form-control" id="manualQRInput" placeholder="Paste QR code content here">
                        <button class="btn btn-secondary mt-2 w-100" onclick="processQRCode()">Process</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Scanned Product Details</h5>
                </div>
                <div class="card-body" id="productDetails">
                    <p class="text-muted">Scan a QR code to see product details</p>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0">Scan History</h5>
                </div>
                <div class="card-body">
                    <div id="scanHistory"></div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script>
        let video, canvas, ctx;
        let isScanning = false;

        $(document).ready(function() {
            video = document.getElementById('scanner');
            canvas = document.createElement('canvas');
            ctx = canvas.getContext('2d');
        });

        function startScanner() {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(stream => {
                    video.srcObject = stream;
                    isScanning = true;
                    scanFrame();
                })
                .catch(err => alert('Camera access denied: ' + err));
        }

        function stopScanner() {
            isScanning = false;
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
        }

        function scanFrame() {
            if (!isScanning) return;

            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);

                if (code) {
                    processQRCode(code.data);
                    stopScanner();
                }
            }

            requestAnimationFrame(scanFrame);
        }

        function processQRCode(qrContent = null) {
            const content = qrContent || $('#manualQRInput').val();
            if (!content) {
                alert('Please scan or enter a QR code');
                return;
            }

            const params = new URLSearchParams(content.split('|').map(p => p.split(':')).flat().join('&'));
            const nftId = params.get('NFT');

            if (!nftId) {
                alert('Invalid QR code format');
                return;
            }

            $.get(`/api/nft/${nftId}`, function(nft) {
                let html = `
                    <div class="mb-3">
                        <h6>Product Name</h6>
                        <p>${nft.productName}</p>
                    </div>
                    <div class="mb-3">
                        <h6>Batch ID</h6>
                        <p>${nft.batchId}</p>
                    </div>
                    <div class="mb-3">
                        <h6>Manufacturer</h6>
                        <p>${nft.manufacturer}</p>
                    </div>
                    <div class="mb-3">
                        <h6>Status</h6>
                        <p><span class="badge bg-info">${nft.status}</span></p>
                    </div>
                    <div class="mb-3">
                        <h6>Created Date</h6>
                        <p>${new Date(nft.createdDate).toLocaleDateString()}</p>
                    </div>
                `;
                $('#productDetails').html(html);

                // Log the scan
                $.post(`/api/qrcode/scan/${nft.id}?scannedBy=User&scannedFrom=Scanner`, function() {
                    loadScanHistory(nft.id);
                });
            });
        }

        function loadScanHistory(nftId) {
            $.get(`/api/qrcode/nft/${nftId}`, function(qrCode) {
                $.get(`/api/qrcode/history/${qrCode.id}`, function(history) {
                    let html = `<p class="mb-2"><strong>Total Scans: ${qrCode.scanCount}</strong></p>`;
                    html += '<table class="table table-sm"><thead><tr><th>Date</th><th>Scanned By</th></tr></thead><tbody>';
                    history.forEach(scan => {
                        html += `<tr><td>${new Date(scan.scanDate).toLocaleString()}</td><td>${scan.scannedBy}</td></tr>`;
                    });
                    html += '</tbody></table>';
                    $('#scanHistory').html(html);
                });
            });
        }
    </script>
}
