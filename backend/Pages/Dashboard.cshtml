@page
@model DashboardModel
@{
    ViewData["Title"] = "Bảng Điều Khiển";
}

<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>Bảng Điều Khiển</h2>
            <p class="text-muted">Chào mừng, <code id="userAddress"></code></p>
        </div>
        <div class="col-md-4 text-end">
            <button class="btn btn-outline-danger" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i> Đăng Xuất
            </button>
        </div>
    </div>

    <div class="row" id="dashboardContent">
        <div class="col-12">
            <div class="alert alert-info">
                <i class="fas fa-spinner fa-spin"></i> Đang tải...
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            loadDashboard();
            
            $('#logoutBtn').click(function() {
                logout();
            });
        });

        function loadDashboard() {
            const walletAddress = localStorage.getItem('walletAddress');
            
            if (!walletAddress) {
                window.location.href = '/login';
                return;
            }

            $('#userAddress').text(walletAddress);

            // Load role-specific dashboard
            $.ajax({
                url: '/api/auth/current-user',
                method: 'GET',
                success: function(response) {
                    if (response.success) {
                        const roleMap = {
                            1: 'Manufacturer',
                            2: 'Distributor',
                            3: 'Pharmacy',
                            4: 'Admin'
                        };
                        
                        const userRole = roleMap[response.userRole];
                        
                        // Redirect to role-specific page
                        switch(userRole) {
                            case 'Manufacturer':
                                window.location.href = '/manufacturer';
                                break;
                            case 'Distributor':
                                window.location.href = '/distributor';
                                break;
                            case 'Pharmacy':
                                window.location.href = '/pharmacy';
                                break;
                            case 'Admin':
                                window.location.href = '/admin/dashboard';
                                break;
                            default:
                                showError('Vai trò không xác định');
                        }
                    } else {
                        showError('Không thể tải thông tin người dùng');
                    }
                },
                error: function() {
                    showError('Lỗi khi tải dữ liệu');
                }
            });
        }

        function logout() {
            $.ajax({
                url: '/api/auth/logout',
                method: 'POST',
                success: function() {
                    localStorage.removeItem('walletAddress');
                    window.location.href = '/login';
                }
            });
        }

        function showError(message) {
            $('#dashboardContent').html(`
                <div class="col-12">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i> ${message}
                    </div>
                </div>
            `);
        }
    </script>
}
