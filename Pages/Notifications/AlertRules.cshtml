@page
@model AlertRulesModel
@{
    ViewData["Title"] = "Alert Rules Management";
}

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-md-12">
            <h1 class="mb-4">Alert Rules Management</h1>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-12">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRuleModal">Add New Rule</button>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Active Alert Rules</h5>
                </div>
                <div class="card-body">
                    <div id="rulesTable"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Rule Modal -->
<div class="modal fade" id="addRuleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Alert Rule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="ruleForm">
                    <div class="mb-3">
                        <label class="form-label">Rule Name</label>
                        <input type="text" class="form-control" id="ruleName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Trigger Type</label>
                        <select class="form-select" id="triggerType" required>
                            <option value="">Select Trigger Type</option>
                            <option value="LowStock">Low Stock</option>
                            <option value="ExpiryWarning">Expiry Warning</option>
                            <option value="TransferPending">Transfer Pending</option>
                            <option value="TransferRejected">Transfer Rejected</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notification Channels</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="channelInApp" value="InApp" checked>
                            <label class="form-check-label" for="channelInApp">In-App</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="channelEmail" value="Email">
                            <label class="form-check-label" for="channelEmail">Email</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="channelSMS" value="SMS">
                            <label class="form-check-label" for="channelSMS">SMS</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveRule()">Save Rule</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            loadRules();
        });

        function loadRules() {
            $.get('/api/notification/alert-rules', function(data) {
                let html = '<table class="table table-hover"><thead><tr><th>Name</th><th>Trigger Type</th><th>Channels</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
                data.forEach(rule => {
                    html += `<tr>
                        <td>${rule.ruleName}</td>
                        <td>${rule.triggerType}</td>
                        <td>${rule.notificationChannels}</td>
                        <td><span class="badge ${rule.isActive ? 'bg-success' : 'bg-danger'}">${rule.isActive ? 'Active' : 'Inactive'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editRule(${rule.id})">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteRule(${rule.id})">Delete</button>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                $('#rulesTable').html(html);
            });
        }

        function saveRule() {
            const channels = [];
            if ($('#channelInApp').is(':checked')) channels.push('InApp');
            if ($('#channelEmail').is(':checked')) channels.push('Email');
            if ($('#channelSMS').is(':checked')) channels.push('SMS');

            const rule = {
                ruleName: $('#ruleName').val(),
                triggerType: $('#triggerType').val(),
                notificationChannels: channels.join(','),
                isActive: true
            };

            $.ajax({
                url: '/api/notification/alert-rules',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(rule),
                success: function() {
                    alert('Rule created successfully');
                    $('#addRuleModal').modal('hide');
                    $('#ruleForm')[0].reset();
                    loadRules();
                }
            });
        }

        function deleteRule(ruleId) {
            if (confirm('Delete this rule?')) {
                $.ajax({
                    url: `/api/notification/alert-rules/${ruleId}`,
                    type: 'DELETE',
                    success: function() {
                        loadRules();
                    }
                });
            }
        }
    </script>
}
