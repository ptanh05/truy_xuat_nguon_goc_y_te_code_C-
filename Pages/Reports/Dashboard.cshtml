@page
@model ReportsDashboardModel
@{
    ViewData["Title"] = "Reports & Analytics";
}

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-md-12">
            <h1 class="mb-4">Reports & Analytics Dashboard</h1>
        </div>
    </div>

    <!-- Date Range Filter -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="startDate">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-control" id="endDate">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-primary w-100" onclick="loadAnalytics()">Load Analytics</button>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-success w-100" onclick="generateReport()">Generate Report</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">Total NFTs</h5>
                    <h2 id="totalNFTs">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">Total Transfers</h5>
                    <h2 id="totalTransfers">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">Success Rate</h5>
                    <h2 id="successRate">0%</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <h5 class="card-title">Pending</h5>
                    <h2 id="pendingTransfers">0</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Transfers by Status</h5>
                </div>
                <div class="card-body">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Daily Transfers</h5>
                </div>
                <div class="card-body">
                    <canvas id="dailyChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Top Products</h5>
                </div>
                <div class="card-body">
                    <div id="topProductsTable"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Generated Reports -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Generated Reports</h5>
                </div>
                <div class="card-body">
                    <div id="reportsTable"></div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let statusChart, dailyChart;

        $(document).ready(function() {
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
            
            $('#startDate').val(thirtyDaysAgo.toISOString().split('T')[0]);
            $('#endDate').val(today.toISOString().split('T')[0]);
            
            loadAnalytics();
            loadReports();
        });

        function loadAnalytics() {
            const startDate = $('#startDate').val();
            const endDate = $('#endDate').val();

            $.get(`/api/report/analytics?startDate=${startDate}&endDate=${endDate}`, function(data) {
                $('#totalNFTs').text(data.totalNFTsCreated);
                $('#totalTransfers').text(data.totalTransfers);
                $('#successRate').text(data.successRate.toFixed(1) + '%');
                $('#pendingTransfers').text(data.pendingTransfers);

                const statusCtx = document.getElementById('statusChart').getContext('2d');
                if (statusChart) statusChart.destroy();
                statusChart = new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(data.transfersByStatus),
                        datasets: [{
                            data: Object.values(data.transfersByStatus),
                            backgroundColor: ['#28a745', '#dc3545', '#ffc107']
                        }]
                    }
                });

                const dailyCtx = document.getElementById('dailyChart').getContext('2d');
                if (dailyChart) dailyChart.destroy();
                dailyChart = new Chart(dailyCtx, {
                    type: 'line',
                    data: {
                        labels: data.dailyTransfers.map(d => new Date(d.date).toLocaleDateString()),
                        datasets: [{
                            label: 'Successful',
                            data: data.dailyTransfers.map(d => d.successful),
                            borderColor: '#28a745',
                            tension: 0.4
                        }, {
                            label: 'Failed',
                            data: data.dailyTransfers.map(d => d.failed),
                            borderColor: '#dc3545',
                            tension: 0.4
                        }]
                    }
                });

                let html = '<table class="table table-hover"><thead><tr><th>Product</th><th>Created</th><th>Transferred</th><th>Stock</th><th>Transfer Rate</th></tr></thead><tbody>';
                data.topProducts.forEach(product => {
                    html += `<tr><td>${product.productName}</td><td>${product.totalCreated}</td><td>${product.totalTransferred}</td><td>${product.currentStock}</td><td>${product.transferRate.toFixed(1)}%</td></tr>`;
                });
                html += '</tbody></table>';
                $('#topProductsTable').html(html);
            });
        }

        function generateReport() {
            const startDate = $('#startDate').val();
            const endDate = $('#endDate').val();
            const reportType = 'Custom';
            const generatedBy = 'Admin'; // Get from current user

            $.ajax({
                url: `/api/report/generate?reportType=${reportType}&startDate=${startDate}&endDate=${endDate}&generatedBy=${generatedBy}`,
                type: 'POST',
                success: function() {
                    alert('Report generated successfully');
                    loadReports();
                }
            });
        }

        function loadReports() {
            $.get('/api/report/list', function(data) {
                let html = '<table class="table table-hover"><thead><tr><th>Name</th><th>Type</th><th>Generated</th><th>By</th><th>Actions</th></tr></thead><tbody>';
                data.forEach(report => {
                    html += `<tr>
                        <td>${report.reportName}</td>
                        <td>${report.reportType}</td>
                        <td>${new Date(report.generatedDate).toLocaleDateString()}</td>
                        <td>${report.generatedBy}</td>
                        <td>
                            <a href="/api/report/${report.id}/export/pdf" class="btn btn-sm btn-danger">PDF</a>
                            <a href="/api/report/${report.id}/export/excel" class="btn btn-sm btn-success">Excel</a>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                $('#reportsTable').html(html);
            });
        }
    </script>
}
